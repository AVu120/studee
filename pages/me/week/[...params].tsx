import { ChevronLeftIcon, ChevronRightIcon } from "@chakra-ui/icons";
import { Button, HStack, IconButton, Text, useToast } from "@chakra-ui/react";
import { Planner } from "components/Planner";
import type { GetServerSideProps, NextPage } from "next";
import Head from "next/head";
import { useRouter } from "next/router";
import { useEffect, useRef, useState } from "react";
import { logOut } from "services/auth";
import { getWeeklyPlanOnClient, updateWeeklyPlan } from "services/weeklyPlans";
import styles from "styles/pages/me/week.module.scss";
import colors from "styles/theme/colors";
import { createEmptyWeeklyPlan } from "utils/constants/weeklyPlans";
import {
  getCurrentStartDate,
  getDateInUrlPath,
  getNextStartDate,
  getPreviousStartDate,
} from "utils/helpers/dateTime";
import { IWeeklyPlan } from "utils/types/weeklyPlans";

import { getUserData } from "../../api/user";
import { getWeeklyPlanOnServer } from "../../api/weeklyPlans";

interface Props {
  weeklyPlan: IWeeklyPlan | null;
}
const Me: NextPage<Props> = ({ weeklyPlan }) => {
  const router = useRouter();

  /** Start date that is set when the page is loaded but weeklyPlan can't be found in the db.  */
  let emptyStartDate: string;
  if (Array.isArray(router?.query?.params)) {
    emptyStartDate = getDateInUrlPath(router?.query?.params);
  } else {
    emptyStartDate = getCurrentStartDate();
  }

  const savedWeeklyPlanRef = useRef(
    weeklyPlan || createEmptyWeeklyPlan(emptyStartDate)
  );
  const [weeklyPlanState, setWeeklyPlanState] = useState(
    weeklyPlan || createEmptyWeeklyPlan(emptyStartDate)
  );
  console.log({ weeklyPlanState });
  const [hasUnsavedChanges, setHasUnsavedChanged] = useState(false);

  useEffect(() => {
    if (
      !hasUnsavedChanges &&
      JSON.stringify(weeklyPlanState) !==
        JSON.stringify(savedWeeklyPlanRef.current)
    ) {
      setHasUnsavedChanged(true);
    }
  }, [weeklyPlanState]);

  const [startDateYear, startDateMonth, startDateDay] =
    weeklyPlanState.startDate.split("/").map((numString) => Number(numString));
  const startDate = `${startDateDay}/${startDateMonth}/${startDateYear}`;

  // endDateObject.setDate(endDateObject.getDate() + 6);
  // const endDateString = `${endDateObject.getDate()}/${
  //   endDateObject.getMonth() + 1
  // }/${endDateObject.getFullYear()}`;

  // Track status of logout request.
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  // Track status of fetching new data e.g. next week or prior week's data.
  const [isLoadingNextWeekData, setIsLoadingNextWeekData] = useState(false);
  const [isLoadingPriorWeekData, setIsLoadingPriorWeekData] = useState(false);

  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState("");
  const toast = useToast();

  const onLogOut = () => logOut(setIsLoggingOut, setError, router, toast);
  const onSave = () =>
    updateWeeklyPlan(
      weeklyPlanState,
      setIsSaving,
      setError,
      toast,
      setHasUnsavedChanged,
      savedWeeklyPlanRef
    );

  const onShowNextWeek = () => {
    const nextStartDate = getNextStartDate({
      currentYear: startDateYear,
      currentMonth: startDateMonth - 1,
      currentDay: startDateDay,
    });
    router.push(`/me/week/${nextStartDate}`, undefined, { shallow: true });
    getWeeklyPlanOnClient(
      nextStartDate,
      setWeeklyPlanState,
      setIsLoadingNextWeekData,
      setError,
      savedWeeklyPlanRef
    );
  };

  const onShowPreviousWeek = () => {
    const previousStartDate = getPreviousStartDate({
      currentYear: startDateYear,
      currentMonth: startDateMonth - 1,
      currentDay: startDateDay,
    });
    router.push(`/me/week/${previousStartDate}`, undefined, {
      shallow: true,
    });
    getWeeklyPlanOnClient(
      previousStartDate,
      setWeeklyPlanState,
      setIsLoadingPriorWeekData,
      setError,
      savedWeeklyPlanRef
    );
  };

  return (
    <div className={styles.page}>
      <Head>
        <title>Studee</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <header
        className={styles.header}
        // @ts-ignore
        style={{ "--bgColor": colors.secondary }}
      >
        {" "}
        <Button
          type="submit"
          variant="primary"
          onClick={onSave}
          disabled={!hasUnsavedChanges || isSaving}
        >
          {isSaving ? "Saving..." : "Save"}
        </Button>
        <HStack>
          <IconButton
            variant="outline"
            aria-label="Show last week"
            isRound
            position="relative"
            right="-4"
            icon={<ChevronLeftIcon fontSize="2rem" />}
            onClick={onShowPreviousWeek}
            isLoading={isLoadingPriorWeekData}
          />
          <Text
            as="h1"
            textAlign="center"
            margin="0px"
          >{`Week of ${startDate}`}</Text>
          <IconButton
            variant="outline"
            aria-label="Show next week"
            isRound
            position="relative"
            left="-4"
            icon={<ChevronRightIcon fontSize="2rem" />}
            onClick={onShowNextWeek}
            isLoading={isLoadingNextWeekData}
          />
        </HStack>
        <Button
          type="submit"
          variant="secondary"
          onClick={onLogOut}
          disabled={isLoggingOut}
        >
          {isLoggingOut ? "Loading..." : "Log Out "}
        </Button>
      </header>

      <main className={styles.main}>
        <Planner
          weeklyPlan={weeklyPlanState}
          setWeeklyPlanState={setWeeklyPlanState}
        />
      </main>

      <footer
        className={styles.footer}
        // @ts-ignore
        style={{ "--bgColor": colors.secondary }}
      >
        <span>Studee App</span>
        <span>
          Created by{" "}
          <a
            href="https://www.linkedin.com/in/anthony-hien-vu/"
            target="_blank"
            rel="noreferrer"
          >
            Anthony Hien Vu
          </a>
        </span>
      </footer>
    </div>
  );
};

export default Me;

export const getServerSideProps: GetServerSideProps = async ({
  req,
  query,
}) => {
  const { cookies } = req;

  if (cookies.session) {
    const userData = await getUserData(cookies.session);

    if (userData) {
      const { user_id: userId } = userData;

      const { params } = query as { params: string[] };
      const startDate = `${params[0]}/${params[1]}/${params[2]}`;

      const weeklyPlan = await getWeeklyPlanOnServer({ userId, startDate });

      return {
        props: { weeklyPlan },
      };
    }
  }

  return {
    redirect: {
      destination: "/",
      permanent: false,
    },
  };
};
